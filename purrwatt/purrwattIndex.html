<html>
<head>
    <!-- <meta http-equiv="Access-Control-Allow-Origin" content="*" /> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="purwatt.css">
    
    <!-- apple homepage icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

  <!-- title bar icon -->
  <link rel="icon"
    href="sun.png"
    type="image/x-icon">

    
  <title>Purrwatt | Save up to 34% more big bucks on electricity</title>


</head>


<!---->


<body>
    <div class="sticky-header">
        <h2 style="text-align: center; flex-grow: 1;">Purrwatt</h2>
        
        <a href="/purrwatt/graphs/"> <!-- goes back to the homepage -->
            <div class="button" style="position: absolute; right: 10; background-image: url(line-graph.png); height: 20px; width: 20px; background-size: cover;"></div>
        </a>
    </div>
    <div style="height: 10px;"></div> <!-- idk its just a divider -->
    
    <h1>Current Energy Avaliability</h1>
    <div class="section" id="current-energy">
            <!-- peak time warning
            <div id="peakMessage" class="hidden">
                <div class="warning-icon"></div>
                <p class="yellow-text" style="padding-top: 7px;">
                    You are currently in a peak usage time.
                </p>  
                <hr style="margin-top: 20px;">
            </div>
            
            
            <div style="display: flex; justify-content: space-between; padding-top: 20px;">
                <p class="green-text" style="margin-bottom: 5px; margin-top: -2px;" id="recommendedtime">--</p>
                <div class="blue-button button" style="margin-top: -10px; height: min-content;" id="reminderbutton" >--</div> 
            </div> -->
            <div class="circle" id="circle">
                <p></p>
            </div>
    </div>
    
    
    
    <div id="time-options"> <!-- time sections go in here -->
        <p>loading data...</p>
    </div>





<script>


function showInfo(idName) {
    document.getElementById(idName).classList.toggle("hidden");
}





var flowers = [];

function createflowers(series) {
    const arr = Object.values(series[0]);
    console.log(series);
    for (let i = 0; i < 2000; i += 12) {
        const subArr = arr.slice(i+1, i+21);
        if (subArr.length === 0) continue;

        const sum = subArr.reduce((accumulator, currentValue) => parseInt(accumulator) + parseInt(currentValue));
        console.log(sum);
        if (sum < 5000*12) {
            flowers.push(3)
            console.log("three flowers");
        } else if (sum < 12500*12) {
            flowers.push(2)
            console.log("two flowers");
        } else if (sum < 20000*12) {
            flowers.push(1)
            console.log("one leaf");
        } else {
            flowers.push(0)
            console.log("no flowers");
        }
    }
    console.log("END DATA:");
    console.log(flowers);
}

function calculateEnergyAvailability(date, ){

}


async function fetchAndGetCsvString() {
    const url = 'https://caiso-proxy-repo.onrender.com/caiso-csv';
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network error');
    const csvString = await response.text();

    console.log('CSV string:', csvString);
    
    // You can now use csvString however you want (send to server, display, etc.)
    return csvString;
  } catch (error) {
    console.error('Error:', error);
  }
}

(async () => {
  try {
    const csvData = await fetchAndGetCsvString();
    if (csvData && csvData.trim() !== '') {

    // Split the CSV data into rows using the newline character
    const rows = csvData.split('\n');
    // Initialize an empty array to hold the series data
    const series = [];

    const obj = {};
    for (let i = 0; i < rows.length; i++) {
        // Split the row into an array using the comma separator
        const row = rows[i].split(',');
        console.log(row);
        obj[row[0]] = (parseInt(row[5]) + parseInt(row[9]))- parseInt(row[3]) + parseInt(row[8]);  

        
        // Add the object to the series array
    }
    series.push(obj);


    //Make current energy avaliability circle
    const circle = document.getElementById("circle");
    const now = new Date();
    const dateString = String((String(now.getMonth()+1).padStart(2, '0')) + "/" + now.getDate()
     + "/" + now.getFullYear() + " " + (now.getMinutes()> 55 ? now.getHours() +1 : now.getHours())
     + ":" + (now.getMinutes()> 55 ? "00" :String(Math.round(parseInt(now.getMinutes()) / 5) * 5).padStart(2, '0')));
    console.log(dateString);
    console.log(series[0][dateString]);
    const goodness = parseInt((parseInt(series[0][dateString]) / 60000) * 100)
    circle.style.backgroundColor = "hsl(" + String((parseInt(series[0][dateString]) / 60000) * 125) + ", 90%, 50%)";

    const smallText = document.createElement("div");
    smallText.classList.add("small-text");
    smallText.textContent = String(goodness > 90 ? "Best"
    : goodness > 75 ? "Great"
    : goodness > 60 ? "Good"
    : goodness >  45? "Okay" 
    : goodness > 30 ? "Poor"
    : goodness > 15 ? "Bad"
    : "Avoid Use");


    circle.appendChild(smallText);
    circle.appendChild(document.createTextNode(goodness));

    //Make hour boxes
    const timeOptions = document.getElementById("time-options");
    const hours = [];
    const numHours = 23-parseInt(now.getHours()) + 6*24;
    for (let i = 0; i < numHours; i++){
        const dateString = String((String(now.getMonth()+1).padStart(2, '0')) + "/" + (parseInt(now.getDate()) + parseInt((i+parseInt(now.getHours()))/24))
        + "/" + now.getFullYear() + " " + String(((parseInt(now.getMinutes()> 55 ? now.getHours() +1 : now.getHours()) + i)%24)).padStart(2, '0')
        + ":" + ("00"));
        const obj = {};
        console.log(dateString);
        obj[dateString] = series[0][dateString];
        hours.push(obj);
    }
    console.log(hours);
    timeOptions.innerHTML = ""; 

    for (let i = 0; i < 11; i++){
        const hourBox = document.createElement("div");
        hourBox.className = "hour";
        const timeText = document.createElement("p");
        //hour
        if (i === 0) {
            hourBox.classList.add("first-hour");
            hourBox.classList.add("selected");
            timeText.textContent = "Now";
        } else{
            timeText.textContent = find12hr(parseInt(Object.keys(hours[i])[0].split(" ")[1].split(":")[0]));
        }
        
        hourBox.appendChild(timeText);
        
        //Circle
        const circle = document.createElement("div");
        circle.className = "small-circle";
        circle.style.backgroundColor = "hsl(" + String((parseInt(Object.values(hours[i])[0]) / 60000) * 125) + ", 90%, 50%)";
        circle.textContent = String(parseInt(parseInt(Object.values(hours[i])[0]) / 60000 * 100));
        hourBox.appendChild(circle);
        if (timeText.textContent === "4 pm" 
        || timeText.textContent === "5 pm" 
        || timeText.textContent === "6 pm" 
        || timeText.textContent === "7 pm" 
        || timeText.textContent === "8 pm" 
        || timeText.textContent === "9 pm"
        || (timeText.textContent === "Now"
        && (parseInt(now.getHours()) >= 16
        && parseInt(now.getHours()) <= 21)
        )) {
            const priceTag = document.createElement("img");
            priceTag.className = "price-tag";
            priceTag.src = "dollar-sign.png";
            hourBox.appendChild(priceTag);
        } 
        
        timeOptions.appendChild(hourBox);
    }
    } else {
    console.warn('CSV string is empty or undefined.');
    }
  } catch (error) {
    console.error('Error:', error);  
  }  
})();  


    function findPrice(t) { // finds the dollar signs of a certain time
        let cost;
        if (t%24 >= 16 && t%24 <= 21) {
            cost = "$$$"
        } else {
            cost = "  $"
        }
        return cost;
    }


    function find12hr(t) { // converts 24 hr time into 12 hr time
        t = t%24;
        let output = t%12;
        let meridiem;
        let opposite;
        if (t > 12 || t == 0) {
            meridiem = " pm";
            opposite = " am";
        } else {
            meridiem = " am";
            opposite = " pm";
        }
        if (output == 0) {
            output = 12;
            meridiem = opposite;
        }
        return output + meridiem
     }


</script>
    
</body>

</html>